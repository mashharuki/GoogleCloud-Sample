# Looker Studio と BigQuery で BI ダッシュボードを構築する

## 概要

- ダッシュボードは使用状況を 1 か所にまとめて表示するものであり、注文 ID などの詳細情報は必要ありません。そのため、クエリ費用を削減するために、必要なログを「Reports」という別のデータセットにまとめて、集計データのテーブルを作成します。

- そのテーブルを Looker ダッシュボードからクエリします。これにより、ダッシュボードの更新時に Reports データセットのクエリで処理されるデータ量を削減できます。過去の使用状況ログは変更されないため、Reports データセットの新しい使用状況データを更新するだけで済みます。

## ハンズオンの記録

BigQueryでパブリックデータセットを選択し、[Street Trees] をクリックし、[データセットを表示] をクリックします。

Qwiklabs のプロジェクト ID（qwiklabs-gcp-03-ac440638921a）の横にある [アクションを表示]（「アクションを表示」アイコン）をクリックし、[データセットを作成] を選択します。

[データセット ID] を「Reports」に設定します。

他のオプションはデフォルト値のままにします。

[データセットを作成] をクリックします。

- 次に、Reports という新しいデータセットをプロジェクトに作成します。独立したデータセットを作成すると 2 つのメリットがあります。1 つは、ダッシュボードによってクエリされるデータの量が減ること、もう 1 つは、集計データにしか関心がないユーザーが無駄にソース データセットにアクセスしなくなることです。

このセクションでは、以下の概要情報を含む昨年度のデータを pull する 1 回限りのクエリを実行します。

- 月ごとの植樹数
- 植樹された樹種
- 植樹された樹木の管理者
- 植樹された樹木の所在地
- 植樹地の情報


```sql
SELECT
 TIMESTAMP_TRUNC(plant_date, MONTH) as plant_month,
  COUNT(tree_id) AS total_trees,
  species,
  care_taker,
  address,
  site_info
FROM
  `bigquery-public-data.san_francisco_trees.street_trees`
WHERE
  address IS NOT NULL
  AND plant_date >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 365 DAY)
  AND plant_date < TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY)
GROUP BY
  plant_month,
  species,
  care_taker,
  address,
  site_info
```

- クエリのアクションバーで、[その他の操作]（その他の操作アイコン）> [その他] > [クエリ設定] をクリックします。
  - [クエリ結果の宛先テーブルを設定する] を選択して、
  - [データセット名] に「Reports」と入力し、前に作成した Reports データセットを選択します。
  - [テーブル ID] に「Trees」と入力します。
  - [宛先テーブルの書き込み設定] で [空の場合に書き込む] を選択します。
 
タスク 4. BigQuery でクエリをスケジュールする

ダッシュボードを最新の状態に保つために、クエリを定期的に実行するようにスケジュールできます。

スケジュールされたクエリは、標準 SQL で作成する必要があります。標準 SQL で作成するクエリには、データ定義言語（DDL）とデータ操作言語（DML）によるステートメントを含めることができます。クエリ文字列と宛先テーブルはパラメータ化が可能で、クエリ結果を日付と時刻で整理できます。

新しいデータがないか毎日チェックするクエリを追加します。新たに植樹が行われると、追加の統計情報で reports.trees テーブルが直接更新されます。

```sql
SELECT
 TIMESTAMP_TRUNC(plant_date, MONTH) as plant_month,
  COUNT(tree_id) AS total_trees,
  species,
  care_taker,
  address,
  site_info
FROM
  `bigquery-public-data.san_francisco_trees.street_trees`

WHERE
  address IS NOT NULL
  AND plant_date >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)
  AND plant_date < TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY)
GROUP BY
  plant_month,
  species,
  care_taker,
  address,
  site_info
```

- [その他の操作] > [スケジュール] をクリックして、[スケジュールされたクエリとしてエクスポート] ページを開きます。以下のとおりに設定します。
  - スケジュールされたクエリの名前: Update_trees_daily
  - スケジュール オプション: 繰り返しの頻度: 時間、繰り返しの頻度: 1 時間
  - [クエリ結果の書き込み先] セクションで、[クエリ結果の宛先テーブルを設定する] を選択し、次を設定します。

- データセット: 「Reports」と入力し、前に作成した Reports データセットを選択します。
  - テーブル ID: Trees
  - 宛先テーブルの書き込み設定: 既存のデータが上書きされないように [テーブルに追加する] を選択します。
  - [保存] をクリックします。

ダイアログをクリックして、生徒のアカウントを選択し、BigQuery Data Transfer Service が Google アカウントにアクセスできるようにします。次に、クエリの置き換えに同意します。

タスク 5. Looker Studio で新しいデータソースを作成する

このタスクでは、上で集計した樹木データを使用して Looker Studio でダッシュボードを構築します。

ブラウザで新しいタブを開いて Looker Studio に移動します。

左上の [作成] をクリックして、[レポート] をクリックします。

国と会社名を入力し、利用規約に同意します。

[続行] をクリックします。

すべてのメール設定で [いいえ] を選択して [続行] をクリックします

タスク 6. Looker Studio で新しいレポートを作成する

[データのレポートへの追加] ダイアログで、[BigQuery] をクリックし、[承認] をクリックします。データを使用するアカウントとして、ラボ インスタンスに関連付けられている受講者ユーザーの認証情報を選択します。

次に、BigQuery コネクタを使用して reports.trees テーブルに接続します。

[最近のプロジェクト] > [qwiklabs-gcp-03-ac440638921a] > [Reports データセット] > [Trees テーブル] を選択します。

[追加] をクリックし、[レポートに追加] をクリックします。

- [グラフを追加] プルダウンをクリックし、希望の種類を選択します。下の例には次の種類のグラフが含まれています。
  - 積み上げ縦棒グラフ。樹種ごとに、月ごとの植樹数と、植樹された樹木の管理者が示されています。
  - スコアカード。昨年度の総植樹数が示されています。
  - 円グラフ。植樹された樹種の構成比が示されています。
  - 表と棒グラフ。植樹地別の植樹数が示されています。

## 参考文献
- [Looker Studio と BigQuery で BI ダッシュボードを構築する](https://www.cloudskillsboost.google/focuses/5538?catalog_rank=%7B%22rank%22%3A37%2C%22num_filters%22%3A0%2C%22has_search%22%3Atrue%7D&parent=catalog&search_id=51435305)
