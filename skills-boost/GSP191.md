# Terraform を使用したモジュール式負荷分散 - リージョン ロードバランサ

## 目標

このラボでは、次の方法について学びます。

- Terraform のロード バランシング モジュールを使用する
- リージョン TCP ロードバランサを作成する
- リージョン内部 TCP ロードバランサを作成する
- Kubernetes Engine を使用してグローバル HTTP ロードバランサを作成する
- グローバル HTTPS コンテンツ ベース ロードバランサを作成する

### ロードバランサーの転送ルール

- リージョン転送ルール
- リージョン内部転送ルール
- グローバル転送ルール

## ハンズオンの記録

GitHubリポジトリをクローン

```bash
git clone https://github.com/GoogleCloudPlatform/terraform-google-lb
cd ~/terraform-google-lb/examples/basic
```

リージョン転送ルールを含む TCP ロードバランサを作成する

```bash
export GOOGLE_PROJECT=$(gcloud config get-value project)
terraform init
```

デフォルトのリージョンをラボで割り当て済みのリージョンに置き換える

```bash
export REGION=us-west1
sed -i 's/us-central1/'"$REGION"'/g' variables.tf
```

リソースをデプロイする

```bash
terraform plan
terraform apply
```

以下のようになればOK!

```bash
Apply complete! Resources: 21 added, 0 changed, 0 destroyed.

Outputs:

load_balancer_default_ip = "34.127.31.178"
```

ロードバランサーのURLをブラウザで開けるようにする

```bash
EXTERNAL_IP=$(terraform output | grep load_balancer_default_ip | cut -d = -f2 | xargs echo -n)
echo "http://${EXTERNAL_IP}"
```

## 参考文献
- [GitHub - terraform-google-modules/terraform-google-lb](https://github.com/terraform-google-modules/terraform-google-lb)
- [バックエンド サービスの概要](https://cloud.google.com/load-balancing/docs/backend-service?hl=ja)
- [転送ルールの概要](https://cloud.google.com/load-balancing/docs/forwarding-rule-concepts?hl=ja)
