# GSP643

## Firebase を使用してサーバーレス ウェブアプリを構築する

## 記録

- Firebaseの始め方(一例)
  - プロジェクトを作成する
    - アプリを作成する
      - Firebase Hostingを有効化する
    - Authenticationを設定する
      - ログイン方法からGoogleを選択する
      - [ドメイン] の見出しで、[承認済みドメイン] メニュー項目をクリックします。
      - ドメインを追加する
        - student-bucket-qwiklabs-gcp-02-872edc4129cb-1.web.app
    - FirebaseFirestoreを設定する
      - [Firestore Database] タイルを選択し、[データベースを作成] をクリックします。
      - ルール等は必要であれば変更する
        ```js
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
          match /customers/{email} {
            allow read, write: if request.auth.token.email == email;
            }
          match /customers/{email}/{document=**} {
            allow read, write: if request.auth.token.email == email;
            }
          }
        }
        ```
      - カスタム サイト ID を使用して Firebase Authentication と Firestore が設定されました。

- Cloud Codeでの作業
  - GitHubリポジトリのクローン
    ```bash
    git clone https://github.com/rosera/pet-theory.git
    ```

    ```bash
    cd lab02
    ```
    
  - 依存関係のインストール
    ```bash
    npm i
    ```

  - Firebaseへのアクセスを承認する

    ```bash
    firebase login --no-localhost
    ```
    
  - Firebaseプロジェクトの初期化

    ```bash
    firebase init
    ```

    矢印キーと Space キーを使用して、[Firestore] と [Hosting] を選択します。シェルで次のように選択されていることを確認して、Enter キーを押します。

    ```bash
     ? Which Firebase CLI features do you want to set up for this folder? Press Space to select features, then Enter to confirm your choices.
     ◯ Realtime Database: Configure a security rules file for Realtime Database and (optionally) provision default insta
     ◉ Firestore: Configure security rules and indexes files for Firestore
     ◯ Functions: Configure a Cloud Functions directory and its files
    ❯◉ Hosting: Configure files for Firebase Hosting and (optionally) set up GitHub Action deploys
     ◯ Hosting: Set up GitHub Action deploys
     ◯ Storage: Configure a security rules file for Cloud Storage
    ```

    - [Use an existing project] まで矢印キーで移動して、Enter キーを押します。
    - リスト qwiklabs-gcp-02-872edc4129cb からプロジェクト ID を選択して、Enter キーを押します。
    - Enter キーを押してから「N」と入力して、firestore.rules ファイルを保持します。
    - Enter キーを押してから「N」と入力して、firestore.indexes.json ファイルを保持します。
    - Enter キーを押して public ディレクトリを保持し、次に「N」と入力して /index.html ファイルの書き換えを禁止します。
    - Enter キーを押して、「Set up automatic builds and deploys with GitHub?」と表示されたら N キーを押します。
    - 404.html ファイルの上書きを確認するメッセージが表示されたら、「N」と入力します。
    - index.html ファイルの上書きを確認するメッセージが表示されたら、「N」と入力します。

- Firebaseへデプロイする

  - `firebase.json`を以下の様に更新する

    ```json
    {
      ...
      "hosting": {
        "site": "student-bucket-qwiklabs-gcp-02-872edc4129cb-1",
        ...
      }
    }
    ```

  - デプロイする

    ```bash
    firebase deploy --only hosting:student-bucket-qwiklabs-gcp-02-872edc4129cb-1
    ```

    以下の様になればOK!

    ```bash
    === Deploying to 'qwiklabs-gcp-02-872edc4129cb'...
    
    i  deploying hosting
    i  hosting[student-bucket-qwiklabs-gcp-02-872edc4129cb-1]: beginning deploy...
    i  hosting[student-bucket-qwiklabs-gcp-02-872edc4129cb-1]: found 7 files in public
    ✔  hosting[student-bucket-qwiklabs-gcp-02-872edc4129cb-1]: file upload complete
    i  hosting[student-bucket-qwiklabs-gcp-02-872edc4129cb-1]: finalizing version...
    ✔  hosting[student-bucket-qwiklabs-gcp-02-872edc4129cb-1]: version finalized
    i  hosting[student-bucket-qwiklabs-gcp-02-872edc4129cb-1]: releasing new version...
    ✔  hosting[student-bucket-qwiklabs-gcp-02-872edc4129cb-1]: release complete
    
    ✔  Deploy complete!
    
    Project Console: https://console.firebase.google.com/project/qwiklabs-gcp-02-872edc4129cb/overview
    Hosting URL: https://student-bucket-qwiklabs-gcp-02-872edc4129cb-1.web.app
    ```

    今回はWebアプリが表示されればOK!

  - ウェブアプリに顧客ページを追加する

    - `public/customer.js ファイルを開き、次のコードをコピーして貼り付けます。` ファイルを開き、次のコードをコピーして貼り付けます。
  
      ```js
      let user;
  
      firebase.auth().onAuthStateChanged(function(newUser) {
        user = newUser;
        if (user) {
          const db = firebase.firestore();
          db.collection("customers").doc(user.email).onSnapshot(function(doc) {
            const cust = doc.data();
            if (cust) {
              document.getElementById('customerName').setAttribute('value', cust.name);
              document.getElementById('customerPhone').setAttribute('value', cust.phone);
            }
            document.getElementById('customerEmail').innerText = user.email;
          });
        }
      });
      
      document.getElementById('saveProfile').addEventListener('click', function(ev) {
        const db = firebase.firestore();
        var docRef = db.collection('customers').doc(user.email);
        docRef.set({
          name: document.getElementById('customerName').value,
          email: user.email,
          phone: document.getElementById('customerPhone').value,
        })
      })
      ```

    - `public/styles.css` ファイルを開き、次のコードを貼り付けます。

      ```css
      body { background: #ECEFF1; color: rgba(0,0,0,0.87); font-family: Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
      #message { background: white; max-width: 360px; margin: 100px auto 16px; padding: 32px 24px 16px; border-radius: 3px; }
      #message h3 { color: #888; font-weight: normal; font-size: 16px; margin: 16px 0 12px; }
      #message h2 { color: #ffa100; font-weight: bold; font-size: 16px; margin: 0 0 8px; }
      #message h1 { font-size: 22px; font-weight: 300; color: rgba(0,0,0,0.6); margin: 0 0 16px;}
      #message p { line-height: 140%; margin: 16px 0 24px; font-size: 14px; }
      #message a { display: block; text-align: center; background: #039be5; text-transform: uppercase; text-decoration: none; color: white; padding: 16px; border-radius: 4px; }
      #message, #message a { box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
      #load { color: rgba(0,0,0,0.4); text-align: center; font-size: 13px; }
      @media (max-width: 600px) {
        body, #message { margin-top: 0; background: white; box-shadow: none; }
        body { border-top: 16px solid #ffa100; }
      }
      ```

    - 更新したらデプロイ

      ```bash
      firebase deploy --only hosting:student-bucket-qwiklabs-gcp-02-872edc4129cb-1
      ```

- Firebase ローカルの導入手順

  - step 1

    ```bash
    npm install firebase
    ```
  - step 2
    
    ```js
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "firebase/app";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
    
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAt-oSrSpLhzihTIOJQ7sWR_aoSGCzxXVQ",
      authDomain: "qwiklabs-gcp-02-872edc4129cb.firebaseapp.com",
      projectId: "qwiklabs-gcp-02-872edc4129cb",
      storageBucket: "qwiklabs-gcp-02-872edc4129cb.firebasestorage.app",
      messagingSenderId: "307426488692",
      appId: "1:307426488692:web:affad12d08ac3596187c21"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    ```
## 参考文献
- [ハンズオンのページ](https://www.cloudskillsboost.google/focuses/8391?catalog_rank=%7B%22rank%22%3A2%2C%22num_filters%22%3A0%2C%22has_search%22%3Atrue%7D&parent=catalog&search_id=50565854)
- [Firestore データベースへデータを読み込む](https://google.qwiklabs.com/catalog_lab/2163?_gl=1*twfm7e*_ga*MTE2NzM2NDgyNC4xNzU0NDg1NjUz*_ga_2X30ZRBDSG*czE3NTQ0ODU2NTIkbzEkZzEkdDE3NTQ0ODU5MDEkajU3JGwwJGgw)
